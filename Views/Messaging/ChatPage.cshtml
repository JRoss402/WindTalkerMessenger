<html>
<head>
	<!-- Import this CDN to use icons -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" /></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.13/signalr.min.js" /></script>
	<style>
		#maindiv {
			border: 3px solid black;
			height: 500px;
			width: 1200px;
			margin: auto;
			border-top-left-radius: 10px;
			border-top-right-radius: 10px;
		}

		#chatList {
			list-style-type: none;
			padding-left: 0px;
		}

		#leftinnerdiv {
			float: left;
			height: 495px;
			width: 75%;
			overflow-y: auto;
		}

		button {
			border-radius: 5px;
			width: 100%;
		}

		#rightinnerdiv {
			float: left;
			height: 500px;
			width: 32%;
		}

		#chatsAside {
			border-left: 2px solid black;
			float: right;
			height: 495px;
			width: 25%;
			justify-content: flex-start;
			display: flex;
			flex-direction: column
		}

		#li {
			display: inline-block;
			width: 100%;
		}

		#username {
			height: 25px;
			margin-top: 10px;
		}
	</style>
</head>

<body>
	<h2 id="userHeading"></h2>
	<div class="container">
		<div class="msg-header">
			<div class="container1">
				@*<img src="user1.png" class="msgimg" />*@
				<div class="active">
				</div>
			</div>
		</div>
		<div class="chat-page">
			<div id="maindiv">
				<ul id="leftinnerdiv">
				</ul>
				<div id="chatsAside">
					<input type="text" id="username" placeholder="Username" />
					<ul id="chatList">
						<!--<button id="getChats" name="getChats">myname</button>-->
					</ul>
				</div>
			</div>
			<div class="msg-bottom">
				<div class="input-group">
					<input type="text"
						   id="message"
						   class="form-control"
						   placeholder="Write message..." />
					<span class="input-group-text send-icon" id="sendButton">
						<i class="bi bi-send"></i>
					</span>
				</div>
			</div>
		</div>
	</div>
</body>
</html>

<script>
	var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
	connection.on("ReceiveMessage", function (user, message) {
		var encodedUser = $("<div />").text(user).html();
		var encodedMsg = $("<div />").text(message).html();
		console.log("Message received from: ", encodedUser, "Message: ", encodedMsg);
		$("#leftinnerdiv").append("<li><strong>" + encodedUser + "</strong>: " + encodedMsg + "</li>");
	});

	connection.on("MessageQueued", function (user) {
		var encodedUser = $("<div />").text(user).html();
		console.log(encodedUser, " is offline.Your message has been queued until they return.");

		$("#leftinnerdiv").append("<li><strong>" + encodedUser + "</strong> is offline. The message will be delivered when they return ...whenever that will be.</li>");
	});

	connection.on("GuestGone", function (user) {
		var encodedUser = $("<div />").text(user).html();

		console.log(encodedUser, " was a guest and have disconnected.");

		$("#leftinnerdiv").append("<li>" + encodedUser + " was either a guest and disconnected or they never existed. Sad either way.</li>");
	});

	connection.on("PrintQueuedMessages", function (messages) {
		messages.forEach(printMsgs)
		function printMsgs(item, index, arr) {
			let chatName = $("<div />").text(item.senderChatName).html();
			let message = $("<div />").text(item.userMessage).html();
			$("#leftinnerdiv").append("<li><strong>" + chatName + "</strong>: " + message + "</li>");
		}
		$("#leftinnerdiv").append("<li>" + encodedUser + " was either a guest and disconnected or they never existed. Sad either way.</li>");
	});
	connection.on("ServerDisconnect", function (user) {
		var encodedUser = $("<div />").text(user).html();
		console.log("User: ", encodedUser, " disconnected.The server timed out");

		$("#leftinnerdiv").append("<li><strong>Server Response Timed Out. You have been disconnected.</strong></li>");
	});

	$("#sendButton").click(function () {
		var username = "";

		console.log("clicked");
		if (!username) {
			username = $("#username").val();
		}
		var message = $("#message").val();
		if (username && message) {
			var encodedMsg = $("<div />").text(message).html();
			$("#leftinnerdiv").append("<li><strong>You</strong>: " + encodedMsg + "</li>");
			connection.invoke("SendMessage", username, message)
				.catch(function (err) {
					return console.error(err.toString());
				});
			$("#message").val("").focus();
		} else if (!username) {
			alert("Please enter your username!");
		}
	});

	connection.start().then(function () {
		console.log("Connected!");
		$.ajax({
			type: "POST",
			//data: { ChatName: chatName },
			//cache: false,
			//async: true,
			url: '@Url.Action("GetUserChatList", "API")',
			dataType: "json",
			success: function (response) {
				response.forEach(getUserChats);
			}
		})
	}).catch(function (err) {
		console.error(err.toString());
	});

	//https://stackoverflow.com/questions/9643311/pass-a-string-parameter-in-an-onclick-function
	//https://stackoverflow.com/questions/1276870/how-to-pass-an-event-object-to-a-function-in-javascript
	//https://stackoverflow.com/questions/39144210/pass-a-variable-to-foreach-function


	function getUserChats(item, index, arr) {
		let name = item;
		$("#chatList").append('<button class="btn btn-primary" onclick="GetMessages(event)" name-arg="'+name+'">' + name + "</button>");
	}
</script>

<script>
	function GetMessages(event) {
		$("#leftinnerdiv").empty();
		var target = $(event.target);
		var chatName = target.attr("name-arg");
		$("#username").val(chatName);

		$.ajax({
			type: "POST",
			data: { ChatName: chatName },
			cache: false,
			async: true,
			url: '@Url.Action("GetReceivedMessages", "API")',
			dataType: "json",
			success: function (response) {
				response.forEach(getChats);
			}
		})
	};
	
	function getChats(item, index, arr) {
		let chatName = $("<div />").text(item.senderChatName).html();
		let message = $("<div />").text(item.userMessage).html();
		let timeStamp = $("<div />").text(item.MessageDate).html();
		let sessionChatName = sessionStorage.getItem('ChatName');
		if (chatName == sessionChatName) {
			$("#leftinnerdiv").append("<li><strong>You</strong>: " + message + "</li>");
		} else {
			$("#leftinnerdiv").append("<li><strong>" + chatName + "</strong>: " + message + "</li>");
		}
	}
</script>